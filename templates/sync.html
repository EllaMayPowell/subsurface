<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Samples - Subsurface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">ðŸŽµ Subsurface</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Upload</a>
                <a class="nav-link active" href="/sync">Sync</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-10 mx-auto">
                <h1 class="text-center mb-4">Sync Music Samples</h1>
                
                <!-- Sample Selection -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Select Samples to Sync</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="sample1" class="form-label">Sample 1 (Reference)</label>
                                <select id="sample1" class="form-select mb-3">
                                    <option value="">Select first sample...</option>
                                </select>
                                <div id="sample1Info" class="sample-info"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="sample2" class="form-label">Sample 2 (To Sync)</label>
                                <select id="sample2" class="form-select mb-3">
                                    <option value="">Select second sample...</option>
                                </select>
                                <div id="sample2Info" class="sample-info"></div>
                            </div>
                        </div>
                        <button id="syncBtn" class="btn btn-primary" onclick="syncSamples()">
                            <span id="syncSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                            Analyze Sync
                        </button>
                    </div>
                </div>

                <!-- Sync Results -->
                <div id="syncResults" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title">Sync Analysis</h5>
                        <div id="syncContent"></div>
                    </div>
                </div>

                <!-- Playback Controls -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Playback Controls</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Sample 1</h6>
                                <audio id="player1" controls class="w-100 mb-2">
                                    Your browser does not support the audio element.
                                </audio>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="playSync(1)">Play</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="pauseAll()">Pause All</button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Sample 2</h6>
                                <audio id="player2" controls class="w-100 mb-2">
                                    Your browser does not support the audio element.
                                </audio>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="playSync(2)">Play</button>
                                    <button class="btn btn-sm btn-outline-success" onclick="playSynchronized()">Play Synced</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentFiles = [];
        let syncData = null;

        async function loadFiles() {
            try {
                const response = await fetch('/files');
                const files = await response.json();
                currentFiles = files;
                
                const sample1Select = document.getElementById('sample1');
                const sample2Select = document.getElementById('sample2');
                
                // Clear and populate selects
                sample1Select.innerHTML = '<option value="">Select first sample...</option>';
                sample2Select.innerHTML = '<option value="">Select second sample...</option>';
                
                files.forEach(file => {
                    const option1 = new Option(file.filename, file.filename);
                    const option2 = new Option(file.filename, file.filename);
                    sample1Select.add(option1);
                    sample2Select.add(option2);
                });
                
            } catch (error) {
                console.error('Error loading files:', error);
            }
        }

        function updateSampleInfo(selectId, infoId) {
            const select = document.getElementById(selectId);
            const infoDiv = document.getElementById(infoId);
            const filename = select.value;
            
            if (!filename) {
                infoDiv.innerHTML = '';
                return;
            }
            
            const file = currentFiles.find(f => f.filename === filename);
            if (file) {
                infoDiv.innerHTML = `
                    <div class="small text-muted">
                        <strong>${file.analysis.tempo.toFixed(1)} BPM</strong> â€¢ 
                        ${file.analysis.duration.toFixed(1)}s â€¢ 
                        ${file.analysis.beat_count} beats
                    </div>
                    <audio controls class="w-100 mt-2">
                        <source src="/audio/${filename}" type="audio/mpeg">
                    </audio>
                `;
                
                // Update main player
                const playerId = selectId === 'sample1' ? 'player1' : 'player2';
                const player = document.getElementById(playerId);
                player.src = `/audio/${filename}`;
            }
        }

        async function syncSamples() {
            const sample1 = document.getElementById('sample1').value;
            const sample2 = document.getElementById('sample2').value;
            
            if (!sample1 || !sample2) {
                alert('Please select both samples');
                return;
            }
            
            if (sample1 === sample2) {
                alert('Please select different samples');
                return;
            }
            
            const syncBtn = document.getElementById('syncBtn');
            const spinner = document.getElementById('syncSpinner');
            
            spinner.classList.remove('d-none');
            syncBtn.disabled = true;
            
            try {
                const response = await fetch('/sync_samples', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file1: sample1,
                        file2: sample2
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    syncData = result;
                    displaySyncResults(result);
                } else {
                    alert('Sync analysis failed: ' + result.error);
                }
                
            } catch (error) {
                alert('Error analyzing sync: ' + error.message);
            } finally {
                spinner.classList.add('d-none');
                syncBtn.disabled = false;
            }
        }

        function displaySyncResults(result) {
            const resultsDiv = document.getElementById('syncResults');
            const contentDiv = document.getElementById('syncContent');
            
            const tempoDiff = result.tempo_difference;
            const ratio = result.sync_ratio;
            
            let statusClass = 'text-success';
            let statusText = 'Excellent match!';
            
            if (tempoDiff > 10) {
                statusClass = 'text-danger';
                statusText = 'Significant tempo difference - sync recommended';
            } else if (tempoDiff > 5) {
                statusClass = 'text-warning';
                statusText = 'Moderate tempo difference';
            }
            
            contentDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Sample 1: ${document.getElementById('sample1').value}</h6>
                        <ul class="list-unstyled">
                            <li><strong>Tempo:</strong> ${result.file1_analysis.tempo.toFixed(2)} BPM</li>
                            <li><strong>Duration:</strong> ${result.file1_analysis.duration.toFixed(2)}s</li>
                            <li><strong>Beats:</strong> ${result.file1_analysis.beat_count}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Sample 2: ${document.getElementById('sample2').value}</h6>
                        <ul class="list-unstyled">
                            <li><strong>Tempo:</strong> ${result.file2_analysis.tempo.toFixed(2)} BPM</li>
                            <li><strong>Duration:</strong> ${result.file2_analysis.duration.toFixed(2)}s</li>
                            <li><strong>Beats:</strong> ${result.file2_analysis.beat_count}</li>
                        </ul>
                    </div>
                </div>
                <hr>
                <div class="sync-analysis">
                    <h6 class="${statusClass}">Sync Status: ${statusText}</h6>
                    <p><strong>Tempo Difference:</strong> ${tempoDiff.toFixed(2)} BPM</p>
                    <p><strong>Sync Ratio:</strong> ${ratio.toFixed(3)}x</p>
                    <div class="alert alert-info">
                        <strong>Recommendation:</strong> ${result.recommendation}
                    </div>
                </div>
            `;
            
            resultsDiv.classList.remove('d-none');
        }

        function playSync(playerNumber) {
            const player = document.getElementById(`player${playerNumber}`);
            pauseAll();
            player.play();
        }

        function pauseAll() {
            document.getElementById('player1').pause();
            document.getElementById('player2').pause();
        }

        function playSynchronized() {
            if (!syncData) {
                alert('Please analyze sync first');
                return;
            }
            
            const player1 = document.getElementById('player1');
            const player2 = document.getElementById('player2');
            
            pauseAll();
            
            // Start both players simultaneously
            // In a more advanced implementation, you would adjust playback rates
            player1.currentTime = 0;
            player2.currentTime = 0;
            
            Promise.all([
                player1.play(),
                player2.play()
            ]).catch(error => {
                console.error('Error playing synchronized:', error);
            });
        }

        // Event listeners
        document.getElementById('sample1').addEventListener('change', function() {
            updateSampleInfo('sample1', 'sample1Info');
        });

        document.getElementById('sample2').addEventListener('change', function() {
            updateSampleInfo('sample2', 'sample2Info');
        });

        // Load files on page load
        loadFiles();
    </script>
</body>
</html>